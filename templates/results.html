<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Backtest results</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <div class="brand"><div class="logo-dot"></div><span>Backtest Results</span></div>
        <nav class="header-actions">
          <a class="btn secondary" href="/">New backtest</a>
        </nav>
      </div>
    </header>
    <main class="container">
      {% if error %}
      <div class="banner" style="background:#3a0f0f;border-color:#7f1d1d;color:#fecaca">Error: {{ error }}</div>
      {% endif %}

      {% if ai_prompt %}
      <div class="strategy-prompt-section">
        <button class="strategy-toggle" onclick="toggleStrategy()">
          <span class="strategy-icon">üìã</span>
          <span class="strategy-title">Strategy Rules</span>
          <span class="toggle-icon">‚ñº</span>
        </button>
        <div class="strategy-panel" id="strategy-panel" style="display: none;">
          <div class="strategy-content">
            <div class="strategy-text">{{ ai_prompt }}</div>
            <div class="strategy-tags">
              <span class="strategy-tag">‚è± 5m timeframe</span>
              <span class="strategy-tag">üìà 20-period SMA</span>
              <span class="strategy-tag">üîä Volume >1.5x</span>
              <span class="strategy-tag">üî¥ Bullish confirmation</span>
              <span class="strategy-tag">üéØ BTST entries</span>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      {% if defaults and (defaults.from_date or defaults.to_date) %}
      <div class="banner" style="opacity:0.85">Date filter applied: {{ defaults.from_date or '...' }} ‚Üí {{ defaults.to_date or '...' }}</div>
      {% endif %}

      <div class="layout-2col">
        <aside class="sidebar">
          <div class="card">
            <h2>Quick Re-run</h2>
            <form id="rerun-form">
              <input type="hidden" name="csv_path" value="{{ csv_path }}" />
              <div class="grid">
                <label>Days
                  <input type="number" name="days" value="{{ (defaults and defaults.days) or 5 }}" min="1" />
                </label>
                <label>SL %
                  <input type="number" name="sl_pct" step="0.01" value="{{ (defaults and defaults.sl_pct) or '' }}" />
                </label>
                <label>TP %
                  <input type="number" name="tp_pct" step="0.01" value="{{ (defaults and defaults.tp_pct) or '' }}" />
                </label>
              </div>
              <div class="grid">
                <label><input type="checkbox" name="cap_small" value="1" checked /> Small</label>
                <label><input type="checkbox" name="cap_mid" value="1" checked /> Mid</label>
                <label><input type="checkbox" name="cap_large" value="1" checked /> Large</label>
              </div>
              <input type="hidden" name="exchange" value="{{ (defaults and defaults.exchange) or 'NSE' }}" />
              <input type="hidden" name="tz" value="{{ (defaults and defaults.tz) or 'Asia/Kolkata' }}" />
              <input type="hidden" name="breakeven_profit_pct" value="{{ (defaults and defaults.breakeven_profit_pct) or '' }}" />
              {% if defaults and defaults.breakeven_at_sl %}
              <input type="hidden" name="breakeven_at_sl" value="1" />
              {% endif %}
              <div style="margin-top:12px">
                <button class="btn primary" type="submit">Re-run</button>
              </div>
            </form>
          </div>

          <div class="card" id="warnings-card" style="display:none">
            <h2>Warnings</h2>
            <ul id="warnings-list"></ul>
          </div>

          <div class="card">
            <h2>Export</h2>
            <div class="grid">
              <button class="btn secondary" id="export-csv">CSV</button>
              <button class="btn secondary" id="export-notes">AI Notes</button>
            </div>
          </div>
        </aside>

        <section class="content">
          <div class="tabs">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="trades">Trades</button>
            <button class="tab-btn" data-tab="entry">Entry Timing</button>
            <button class="tab-btn" data-tab="caps">Cap Buckets</button>
          </div>

          <section class="tab-panel active" id="tab-overview">
      {% if stats %}
      <section class="metrics">
        <!-- Primary KPIs - Consistent order and styling -->
        <div class="metric kpi primary-kpi" data-kpi="trades">
          <div class="k">Trades</div>
          <div class="v">{{ '%.0f'|format(stats['trades']) }}</div>
        </div>
        {% if audit_summary %}
        <div class="metric kpi primary-kpi pass-rate-kpi" data-kpi="pass-rate">
          <div class="k">Pass Rate</div>
          <div class="v pass-rate-{{ 'good' if audit_summary.pass_rate >= 80 else 'warn' if audit_summary.pass_rate >= 60 else 'bad' }}">
            {{ '%.1f'|format(audit_summary.pass_rate) }}%
          </div>
        </div>
        {% endif %}
        <div class="metric kpi primary-kpi" data-kpi="win">
          <div class="k">Win Rate</div>
          <div class="v">{{ '%.1f'|format(stats['win_rate_pct']) }}%</div>
        </div>
        <div class="metric kpi primary-kpi" data-kpi="return">
          <div class="k">Compounded Return</div>
          <div class="v">{{ '%.2f'|format(stats.get('compounded_return_pct', stats['total_return_pct'])) }}%</div>
        </div>
        <div class="metric kpi primary-kpi" data-kpi="drawdown">
          <div class="k">Max Drawdown</div>
          <div class="v">{{ '%.2f'|format(stats['max_drawdown_pct']) }}%</div>
        </div>
        
        <!-- Secondary metrics -->
        <div class="metric secondary-metric" title="Risk to Reward Ratio">
          <div class="k">R:R</div>
          <div class="v">{{ '%.2f'|format(stats['risk_reward']) }}</div>
        </div>
        <div class="metric secondary-metric" title="Expected return per trade">
          <div class="k">Expectancy</div>
          <div class="v">{{ '%.2f'|format(stats['expectancy_pct']) }}%</div>
        </div>
        <div class="metric secondary-metric" title="Return to Max Drawdown ratio">
          <div class="k">Calmar</div>
          <div class="v">{{ '%.2f'|format(stats['calmar_ratio']) }}</div>
        </div>
      </section>
      {% endif %}

      {% if audit_summary %}
      <section class="audit-summary" style="margin-top: 16px;">
        <div class="card">
          <div class="audit-header">
            <h3>üîç Trade Audit Summary</h3>
            <div class="audit-status">
              <span class="audit-status-label">Audit Status</span>
              <span class="audit-status-value audit-{{ 'good' if audit_summary.pass_rate >= 80 else 'warn' if audit_summary.pass_rate >= 60 else 'bad' }}">
                {{ 'Compliant' if audit_summary.pass_rate >= 80 else 'Needs Review' if audit_summary.pass_rate >= 60 else 'Critical Issues' }}
              </span>
            </div>
          </div>
          
          <div class="audit-metrics">
            <div class="audit-metric">
              <div class="k">Strategy Types</div>
              <div class="v">
                {% for strategy, count in audit_summary.strategy_distribution.items() %}
                  <span class="strategy-badge strategy-{{ strategy.lower() }}">{{ strategy }}: {{ count }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="audit-metric">
              <div class="k">Total Trades</div>
              <div class="v">{{ audit_summary.total_trades }}</div>
            </div>
            <div class="audit-metric">
              <div class="k">Failed Trades</div>
              <div class="v failed-count">{{ audit_summary.failed_trades }}</div>
            </div>
          </div>
          
          {% if audit_summary.common_violations %}
          <div class="violations-section">
            <button class="violations-toggle" onclick="toggleViolations()">
              <span class="toggle-icon">‚ñº</span>
              <span class="toggle-text">View Violations ({{ audit_summary.common_violations|length }})</span>
            </button>
            <div class="violations-panel" id="violations-panel" style="display: none;">
              <div class="violations-grid">
                {% for violation, count in audit_summary.common_violations %}
                <div class="violation-item">
                  <span class="violation-text">{{ violation }}</span>
                  <span class="violation-count">{{ count }}x</span>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </section>
      {% endif %}

            <div class="card raise equity-chart-card" style="padding:0;margin-top:12px">
              <div class="chart-header">
                <h3>Equity Curve</h3>
                <div class="chart-controls">
                  <button class="chart-toggle active" data-view="cumulative">Cumulative</button>
                  <button class="chart-toggle" data-view="per-trade">Per Trade</button>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="equityChart" height="300"></canvas>
                <div class="chart-labels">
                  <div class="y-axis-label">Equity Value</div>
                  <div class="x-axis-label">Trade Number</div>
                </div>
              </div>
              <div class="chart-footer">
                <div class="chart-stats">
                  <span class="chart-stat">Start: <span id="equity-start">100</span></span>
                  <span class="chart-stat">End: <span id="equity-end">100</span></span>
                  <span class="chart-stat">Peak: <span id="equity-peak">100</span></span>
                  <span class="chart-stat">Trough: <span id="equity-trough">100</span></span>
                </div>
              </div>
            </div>

            <div class="card" id="ai-summary">
              <h2>AI Summary</h2>
              <div id="ai-summary-text" class="sub">Generating summary...</div>
            </div>
          </section>

          <section class="tab-panel" id="tab-trades">
            <div class="card">
              <div class="trades-controls">
                <div class="controls-row">
                  <div class="control-group">
                    <label>Filter
                      <select id="trade-filter">
                        <option value="all">All trades</option>
                        <option value="winners">Winners</option>
                        <option value="losers">Losers</option>
                        <option value="tp">TP hit</option>
                        <option value="sl">SL hit</option>
                        <option value="btst">BTST trades</option>
                        <option value="errors">With errors</option>
                      </select>
                    </label>
                  </div>
                  <div class="control-group">
                    <label>Sort by
                      <select id="trade-sort">
                        <option value="none">None</option>
                        <option value="ret_desc">Return % (desc)</option>
                        <option value="ret_asc">Return % (asc)</option>
                        <option value="date_desc">Date (newest)</option>
                        <option value="date_asc">Date (oldest)</option>
                      </select>
                    </label>
                  </div>
                  <div class="control-group">
                    <label>Show
                      <select id="trades-per-page">
                        <option value="25">25 per page</option>
                        <option value="50" selected>50 per page</option>
                        <option value="100">100 per page</option>
                        <option value="all">All</option>
                      </select>
                    </label>
                  </div>
                </div>
                <div class="trades-summary">
                  <span id="trades-count">Loading...</span>
                  <span id="trades-pagination"></span>
                </div>
              </div>
              
              <div class="table-wrap">
                <table id="trades-table">
                  <thead>
                    <tr>
                      <th>Stock</th>
                      <th>Entry Date</th>
                      <th>Entry Time</th>
                      <th>Entry Price</th>
                      <th>Exit Date</th>
                      <th>Exit Time</th>
                      <th>Exit Price</th>
                      <th>Exit Reason</th>
                      <th>Return %</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="trades-body">
                    {% for row in rows %}
                    <tr class="trade-row" data-stock="{{ row['Stock'] }}" data-return="{{ row.get('Return %', 0) }}" data-reason="{{ row.get('Exit Reason', '') }}" data-error="{{ row.get('Error', '') }}">
                      <td class="stock-cell">{{ row["Stock"] }}</td>
                      <td>{{ row["Entry Date"] or "-" }}</td>
                      <td>{{ row["Entry Time"] or "-" }}</td>
                      <td class="price-cell">{{ row["Entry Price"] if row["Entry Price"] and row["Entry Price"] != 0 else "-" }}</td>
                      <td>{{ row["Exit Date"] or "-" }}</td>
                      <td>{{ row.get("Exit Time", "-") }}</td>
                      <td class="price-cell">{{ row["Exit Price"] if row["Exit Price"] and row["Exit Price"] != 0 else "-" }}</td>
                      <td class="reason-cell">
                        {% if row.get("Exit Reason") %}
                          <span class="reason-badge reason-{{ row.get('Exit Reason', '').lower().replace(' ', '-') }}">{{ row.get("Exit Reason") }}</span>
                        {% else %}
                          <span class="reason-badge reason-none">-</span>
                        {% endif %}
                      </td>
                      <td class="return-cell">
                        {% set return_val = row.get("Return %", 0) %}
                        {% if return_val and return_val != 0 %}
                          <span class="return-value return-{{ 'positive' if return_val > 0 else 'negative' if return_val < 0 else 'neutral' }}">
                            {{ '%.2f'|format(return_val) }}%
                          </span>
                        {% else %}
                          <span class="return-value return-neutral">-</span>
                        {% endif %}
                      </td>
                      <td class="status-cell">
                        {% if row.get("Error") %}
                          <span class="status-badge status-error" title="{{ row.get('Error', '') }}">‚ö†Ô∏è</span>
                        {% else %}
                          <span class="status-badge status-success">‚úÖ</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="tab-panel" id="tab-entry">
            {% if insights and insights.top_entry_times %}
            <div class="card">
              <h2>Best entry times</h2>
              <canvas id="entryChart" height="140"></canvas>
              <div class="table-wrap" style="margin-top:12px"><table>
                <thead><tr><th>Entry Time</th><th>Trades</th><th>TP hits</th><th>TP hit %</th><th>Avg Return %</th></tr></thead>
                <tbody>
                  {% for t in insights.top_entry_times %}
                  <tr>
                    <td>{{ t.time }}</td><td>{{ t.trades }}</td><td>{{ t.tp_hits }}</td><td>{{ '%.2f'|format(t.tp_hit_rate) }}</td><td>{{ '%.2f'|format(t.avg_return) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table></div>
            </div>
            {% endif %}
          </section>

          <section class="tab-panel" id="tab-caps">
            {% if insights and insights.cap_performance %}
            <div class="card">
              <h2>Cap bucket performance</h2>
              <canvas id="capChart" height="140"></canvas>
            </div>
            {% endif %}
          </section>
        </section>

        <aside class="assistant-panel" id="assistant">
          <div class="assistant-header">
            <strong>AI Assistant</strong>
            <button id="assistant-toggle">‚áî</button>
          </div>
          <div id="assistant-body">
            <div class="assistant-insights" id="assistant-insights">
              <div class="insight-item">
                <span class="insight-icon">üí°</span>
                <span class="insight-text">I see your win rate is <span id="insight-win-rate">loading...</span>%</span>
              </div>
              <div class="insight-item">
                <span class="insight-icon">üìä</span>
                <span class="insight-text">Max drawdown: <span id="insight-drawdown">loading...</span>%</span>
              </div>
              <div class="insight-item">
                <span class="insight-icon">üéØ</span>
                <span class="insight-text">Pass rate: <span id="insight-pass-rate">loading...</span>%</span>
              </div>
              <div class="insight-item">
                <span class="insight-icon">üìà</span>
                <span class="insight-text">Total return: <span id="insight-return">loading...</span>%</span>
              </div>
            </div>
            
            <div class="suggested-prompts">
              <div class="prompts-header">Quick Actions:</div>
              <div class="prompt-chips">
                <button class="prompt-chip" data-prompt="What are the main risks in this strategy?">Risks</button>
                <button class="prompt-chip" data-prompt="Which cap buckets perform best?">Cap Analysis</button>
                <button class="prompt-chip" data-prompt="How can I improve the win rate?">Improve Win Rate</button>
                <button class="prompt-chip" data-prompt="What's the optimal SL/TP ratio?">SL/TP Optimization</button>
                <button class="prompt-chip" data-prompt="Show me the best entry times">Entry Timing</button>
                <button class="prompt-chip" data-prompt="Explain the audit violations">Audit Issues</button>
              </div>
            </div>
            
            <div class="assistant-actions">
              <button class="action-btn" onclick="exportResults()">üìä Export Results</button>
              <button class="action-btn" onclick="shareResults()">üîó Share Analysis</button>
            </div>
            
            <div class="assistant-messages" id="assistant-messages"></div>
            <form id="assistant-form">
              <input type="text" id="assistant-input" placeholder="Ask about risks, caps, SL/TP..." />
              <button class="btn primary" type="submit">Ask</button>
            </form>
          </div>
        </aside>
      </div>

    </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  {% if equity %}
  <script id="equity-data" type="application/json">{{ equity | tojson | safe }}</script>
  {% endif %}
    <script id="backtest-json" type="application/json">{ "stats": {{ stats | default({}) | tojson | safe }}, "insights": {{ insights | default({}) | tojson | safe }}, "rows": {{ rows | default([]) | tojson | safe }} }</script>
  <script>
      // Tabs
      document.querySelectorAll('.tab-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          document.querySelectorAll('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
          document.querySelectorAll('.tab-panel').forEach(function(p){ p.classList.remove('active'); });
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });

      // KPI coloring
      (function(){
        try{
          var stats = JSON.parse(document.getElementById('backtest-json').textContent).stats || {};
          function badge(el, good, warn){
            var v = parseFloat(el.querySelector('.v').textContent);
            el.classList.remove('kpi-good','kpi-warn','kpi-bad');
            if (isNaN(v)) return;
            if (good(v)) el.classList.add('kpi-good'); else if (warn(v)) el.classList.add('kpi-warn'); else el.classList.add('kpi-bad');
          }
          document.querySelectorAll('.metric.kpi').forEach(function(el){
            var type = el.dataset.kpi;
            if (type === 'win') badge(el, function(v){return v>=50}, function(v){return v>=40});
            if (type === 'return') badge(el, function(v){return v>=20}, function(v){return v>=10});
            if (type === 'drawdown') badge(el, function(v){return v<=8}, function(v){return v<=15});
          });
        }catch(e){}
      })();

      // Enhanced Equity chart with dynamic stats
    (function(){
      try{
        var el = document.getElementById('equity-data');
        if(!el) return;
        var data = JSON.parse(el.textContent || '[]');
        if(!data.length) return;
        var ctx = document.getElementById('equityChart');
        var labels = data.map(function(_, i){ return i + 1; });
        
        // Calculate dynamic stats
        var startValue = data[0] || 100;
        var endValue = data[data.length - 1] || 100;
        var peakValue = Math.max(...data);
        var troughValue = Math.min(...data);
        
        // Update chart stats
        document.getElementById('equity-start').textContent = startValue.toFixed(0);
        document.getElementById('equity-end').textContent = endValue.toFixed(0);
        document.getElementById('equity-peak').textContent = peakValue.toFixed(0);
        document.getElementById('equity-trough').textContent = troughValue.toFixed(0);
        
        // Create win/loss markers
        var winLossMarkers = data.map(function(value, index) {
          if (index === 0) return null;
          var prevValue = data[index - 1];
          return {
            x: index + 1,
            y: value,
            color: value >= prevValue ? '#10b981' : '#ef4444',
            radius: 3
          };
        }).filter(Boolean);
        
        new Chart(ctx, {
          type: 'line',
          data: { 
            labels: labels, 
            datasets: [
              { 
                label: 'Equity (Base=100)', 
                data: data, 
                borderColor: '#22c55e', 
                backgroundColor: 'rgba(34,197,94,0.15)', 
                tension: 0.2, 
                fill: true, 
                pointRadius: 0,
                pointHoverRadius: 6
              }
            ]
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
              legend: { display: false },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return 'Trade #' + context[0].label;
                  },
                  label: function(context) {
                    return 'Equity: ' + context.parsed.y.toFixed(2);
                  }
                }
              }
            }, 
            scales: { 
              x: { 
                title: { display: true, text: 'Trade Number', color: '#9ca3af' },
                grid: { color: 'rgba(255,255,255,0.06)' } 
              }, 
              y: { 
                title: { display: true, text: 'Equity Value', color: '#9ca3af' },
                grid: { color: 'rgba(255,255,255,0.06)' } 
              } 
            },
            interaction: {
              intersect: false,
              mode: 'index'
            }
          }
        });
      } catch(e) {}
    })();

      // Entry timing chart
      (function(){
        try{
          var data = (JSON.parse(document.getElementById('backtest-json').textContent).insights || {}).top_entry_times || [];
          if(!data.length) return;
          var ctx = document.getElementById('entryChart');
          new Chart(ctx, {
            type: 'bar',
            data: { labels: data.map(function(d){return d.time;}), datasets: [
              { label: 'TP hit %', data: data.map(function(d){return d.tp_hit_rate;}), backgroundColor: 'rgba(34,197,94,0.6)' },
              { label: 'Avg Return %', data: data.map(function(d){return d.avg_return;}), backgroundColor: 'rgba(59,130,246,0.6)' }
            ]},
            options: { responsive: true, scales: { x: { stacked: true }, y: { beginAtZero: true } } }
          });
        }catch(e){}
      })();

      // Cap bucket chart
      (function(){
        try{
          var caps = (JSON.parse(document.getElementById('backtest-json').textContent).insights || {}).cap_performance || [];
          if(!caps.length) return;
          var ctx = document.getElementById('capChart');
          new Chart(ctx, {
            type: 'bar',
            data: { labels: caps.map(function(c){return c.cap;}), datasets: [
              { label: 'Win %', data: caps.map(function(c){return c.win_rate;}), backgroundColor: 'rgba(34,197,94,0.6)' },
              { label: 'Avg Return %', data: caps.map(function(c){return c.avg_return;}), backgroundColor: 'rgba(59,130,246,0.6)' }
            ] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
          });
        }catch(e){}
      })();

      // Trades filters and warnings
      (function(){
        try{
          var rows = JSON.parse(document.getElementById('backtest-json').textContent).rows || [];
          var tbody = document.getElementById('trades-body');
          var filterEl = document.getElementById('trade-filter');
          var sortEl = document.getElementById('trade-sort');

          function render(){
            var data = rows.slice();
            var f = filterEl.value;
            if (f !== 'all'){
              data = data.filter(function(r){
                var ret = parseFloat(r['Return %'] || 0);
                var reason = (r['Exit Reason'] || '').toLowerCase();
                if (f==='winners') return ret>0;
                if (f==='losers') return ret<0;
                if (f==='tp') return reason.indexOf('tp')>=0 || reason.indexOf('take')>=0;
                if (f==='sl') return reason.indexOf('sl')>=0 || reason.indexOf('stop')>=0;
                return true;
              });
            }
            var s = sortEl.value;
            if (s==='ret_desc') data.sort(function(a,b){ return (parseFloat(b['Return %']||0) - parseFloat(a['Return %']||0)); });
            if (s==='ret_asc') data.sort(function(a,b){ return (parseFloat(a['Return %']||0) - parseFloat(b['Return %']||0)); });

            tbody.innerHTML = data.map(function(r){
              return '<tr>'+
                '<td>'+ (r['Stock']||'') +'</td>'+
                '<td>'+ (r['Entry Date']||'') +'</td>'+
                '<td>'+ (r['Entry Time']||'') +'</td>'+
                '<td>'+ (r['Entry Price']||'') +'</td>'+
                '<td>'+ (r['Exit Date']||'') +'</td>'+
                '<td>'+ (r['Exit Time']||'') +'</td>'+
                '<td>'+ (r['Exit Price']||'') +'</td>'+
                '<td>'+ (r['Exit Reason']||'') +'</td>'+
                '<td>'+ (r['Return %']||'') +'</td>'+
                '<td>'+ (r['Error']||'') +'</td>'+
              '</tr>';
            }).join('');
          }

          render();
          filterEl.addEventListener('change', render);
          sortEl.addEventListener('change', render);

          // Warnings
          var warnings = Array.from(new Set(rows.map(function(r){ return (r['Error']||'').trim(); }).filter(Boolean)));
          if (warnings.length){
            document.getElementById('warnings-card').style.display = '';
            var ul = document.getElementById('warnings-list');
            warnings.forEach(function(w){
              var li = document.createElement('li'); li.textContent = w; ul.appendChild(li);
            });
          }
        }catch(e){}
      })();

      // Quick rerun
      (function(){
        var form = document.getElementById('rerun-form');
        if(!form) return;
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          var fd = new FormData(form);
          var resp = await fetch('/ui/rerun', { method: 'POST', body: fd });
          var html = await resp.text(); document.open(); document.write(html); document.close();
        });
      })();

      // Assistant
      (function(){
        var toggle = document.getElementById('assistant-toggle');
        var panel = document.getElementById('assistant');
        toggle.addEventListener('click', function(){ panel.classList.toggle('collapsed'); });

        var btJson = document.getElementById('backtest-json').textContent;
        async function aiSummary(){
          try{
            var fd = new FormData(); fd.append('bt_json', btJson);
            var r = await fetch('/ui/ai_summary', { method: 'POST', body: fd });
            var t = await r.text();
            document.getElementById('ai-summary-text').textContent = t;
          }catch(e){ document.getElementById('ai-summary-text').textContent = 'AI summary unavailable'; }
        }
        aiSummary();

        var form = document.getElementById('assistant-form');
        var input = document.getElementById('assistant-input');
        var msgs = document.getElementById('assistant-messages');
        function addMsg(text, who){
          var div = document.createElement('div');
          div.className = 'msg msg-'+who; div.textContent = text; msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
        }
        form.addEventListener('submit', async function(e){
          e.preventDefault(); var q = input.value.trim(); if(!q) return; addMsg(q,'user'); input.value='';
          try{ var fd = new FormData(); fd.append('question', q); fd.append('bt_json', btJson); var r = await fetch('/ui/ai_chat', { method:'POST', body: fd }); var t = await r.text(); addMsg(t,'ai'); }catch(e){ addMsg('AI unavailable','ai'); }
        });
      })();

      // Export actions
      (function(){
        var btnCsv = document.getElementById('export-csv');
        var btnNotes = document.getElementById('export-notes');
        if(btnCsv){ btnCsv.addEventListener('click', function(){
          var f = new FormData(document.getElementById('rerun-form'));
          fetch('/ui/export_csv', { method:'POST', body: f }).then(function(r){ return r.blob(); }).then(function(b){ var a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backtest.csv'; a.click(); });
        }); }
        if(btnNotes){ btnNotes.addEventListener('click', function(){ var f = new FormData(); f.append('bt_json', document.getElementById('backtest-json').textContent); fetch('/ui/export_notes', { method:'POST', body: f }).then(function(r){ return r.blob(); }).then(function(b){ var a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'ai_notes.txt'; a.click(); }); }); }
      })();

      // Strategy toggle
      function toggleStrategy() {
        var panel = document.getElementById('strategy-panel');
        var icon = document.querySelector('.strategy-toggle .toggle-icon');
        if (panel.style.display === 'none') {
          panel.style.display = 'block';
          icon.textContent = '‚ñ≤';
        } else {
          panel.style.display = 'none';
          icon.textContent = '‚ñº';
        }
      }

      // Violations toggle
      function toggleViolations() {
        var panel = document.getElementById('violations-panel');
        var icon = document.querySelector('.violations-toggle .toggle-icon');
        if (panel.style.display === 'none') {
          panel.style.display = 'block';
          icon.textContent = '‚ñ≤';
        } else {
          panel.style.display = 'none';
          icon.textContent = '‚ñº';
        }
      }

      // Enhanced trades table with pagination
      (function(){
        var rows = JSON.parse(document.getElementById('backtest-json').textContent).rows || [];
        var tbody = document.getElementById('trades-body');
        var filterEl = document.getElementById('trade-filter');
        var sortEl = document.getElementById('trade-sort');
        var perPageEl = document.getElementById('trades-per-page');
        var countEl = document.getElementById('trades-count');
        var paginationEl = document.getElementById('trades-pagination');
        
        var currentPage = 1;
        var itemsPerPage = 50;
        
        function updatePagination(totalItems, currentPage, itemsPerPage) {
          var totalPages = Math.ceil(totalItems / itemsPerPage);
          var pagination = '';
          
          if (totalPages > 1) {
            pagination += '<div class="pagination">';
            if (currentPage > 1) {
              pagination += '<button onclick="goToPage(' + (currentPage - 1) + ')">‚Äπ Prev</button>';
            }
            pagination += '<span class="page-info">Page ' + currentPage + ' of ' + totalPages + '</span>';
            if (currentPage < totalPages) {
              pagination += '<button onclick="goToPage(' + (currentPage + 1) + ')">Next ‚Ä∫</button>';
            }
            pagination += '</div>';
          }
          
          paginationEl.innerHTML = pagination;
        }
        
        window.goToPage = function(page) {
          currentPage = page;
          render();
        };
        
        function render(){
          var data = rows.slice();
          var f = filterEl.value;
          
          // Apply filters
          if (f !== 'all'){
            data = data.filter(function(r){
              var ret = parseFloat(r['Return %'] || 0);
              var reason = (r['Exit Reason'] || '').toLowerCase();
              var error = (r['Error'] || '').toLowerCase();
              
              if (f==='winners') return ret>0;
              if (f==='losers') return ret<0;
              if (f==='tp') return reason.indexOf('tp')>=0 || reason.indexOf('take')>=0;
              if (f==='sl') return reason.indexOf('sl')>=0 || reason.indexOf('stop')>=0;
              if (f==='btst') return reason.indexOf('btst')>=0;
              if (f==='errors') return error.length > 0;
              return true;
            });
          }
          
          // Apply sorting
          var s = sortEl.value;
          if (s==='ret_desc') data.sort(function(a,b){ return (parseFloat(b['Return %']||0) - parseFloat(a['Return %']||0)); });
          if (s==='ret_asc') data.sort(function(a,b){ return (parseFloat(a['Return %']||0) - parseFloat(b['Return %']||0)); });
          if (s==='date_desc') data.sort(function(a,b){ return new Date(b['Entry Date']||0) - new Date(a['Entry Date']||0); });
          if (s==='date_asc') data.sort(function(a,b){ return new Date(a['Entry Date']||0) - new Date(b['Entry Date']||0); });
          
          // Update count
          countEl.textContent = data.length + ' trades';
          
          // Apply pagination
          var startIndex = (currentPage - 1) * itemsPerPage;
          var endIndex = startIndex + itemsPerPage;
          var paginatedData = data.slice(startIndex, endIndex);
          
          // Update pagination controls
          updatePagination(data.length, currentPage, itemsPerPage);
          
          // Render table
          tbody.innerHTML = paginatedData.map(function(r){
            var returnVal = parseFloat(r['Return %'] || 0);
            var returnClass = returnVal > 0 ? 'positive' : returnVal < 0 ? 'negative' : 'neutral';
            var reasonClass = (r['Exit Reason'] || '').toLowerCase().replace(/\s+/g, '-');
            
            return '<tr class="trade-row">'+
              '<td class="stock-cell">'+ (r['Stock']||'') +'</td>'+
              '<td>'+ (r['Entry Date']||'-') +'</td>'+
              '<td>'+ (r['Entry Time']||'-') +'</td>'+
              '<td class="price-cell">'+ (r['Entry Price'] && r['Entry Price'] != 0 ? r['Entry Price'] : '-') +'</td>'+
              '<td>'+ (r['Exit Date']||'-') +'</td>'+
              '<td>'+ (r['Exit Time']||'-') +'</td>'+
              '<td class="price-cell">'+ (r['Exit Price'] && r['Exit Price'] != 0 ? r['Exit Price'] : '-') +'</td>'+
              '<td class="reason-cell"><span class="reason-badge reason-'+reasonClass+'">'+ (r['Exit Reason']||'-') +'</span></td>'+
              '<td class="return-cell"><span class="return-value return-'+returnClass+'">'+ (returnVal != 0 ? returnVal.toFixed(2) + '%' : '-') +'</span></td>'+
              '<td class="status-cell"><span class="status-badge status-'+ (r['Error'] ? 'error' : 'success') +'" title="'+ (r['Error']||'') +'">'+ (r['Error'] ? '‚ö†Ô∏è' : '‚úÖ') +'</span></td>'+
            '</tr>';
          }).join('');
        }

        // Event listeners
        filterEl.addEventListener('change', function(){ currentPage = 1; render(); });
        sortEl.addEventListener('change', function(){ currentPage = 1; render(); });
        perPageEl.addEventListener('change', function(){ 
          itemsPerPage = perPageEl.value === 'all' ? rows.length : parseInt(perPageEl.value);
          currentPage = 1; 
          render(); 
        });

        // Initial render
        render();
      })();

      // AI Assistant enhancements
      (function(){
        // Update insights with actual data
        try {
          var stats = JSON.parse(document.getElementById('backtest-json').textContent).stats || {};
          var auditSummary = JSON.parse(document.getElementById('backtest-json').textContent).audit_summary || {};
          
          document.getElementById('insight-win-rate').textContent = (stats.win_rate_pct || 0).toFixed(1);
          document.getElementById('insight-drawdown').textContent = (stats.max_drawdown_pct || 0).toFixed(1);
          document.getElementById('insight-pass-rate').textContent = (auditSummary.pass_rate || 0).toFixed(1);
          document.getElementById('insight-return').textContent = (stats.get('compounded_return_pct', stats['total_return_pct']) || 0).toFixed(1);
        } catch(e) {}
        
        // Prompt chips
        document.querySelectorAll('.prompt-chip').forEach(function(chip) {
          chip.addEventListener('click', function() {
            var prompt = this.dataset.prompt;
            document.getElementById('assistant-input').value = prompt;
            document.getElementById('assistant-input').focus();
          });
        });
        
        // Action buttons
        window.exportResults = function() {
          document.getElementById('export-csv').click();
        };
        
        window.shareResults = function() {
          // Copy results URL to clipboard
          navigator.clipboard.writeText(window.location.href).then(function() {
            alert('Results URL copied to clipboard!');
          });
        };
      })();
  </script>
  </body>
  </html>


