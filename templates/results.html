<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Backtest results</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <div class="brand"><div class="logo-dot"></div><span>Backtest Results</span></div>
        <nav class="header-actions"><a class="btn secondary" href="/">New backtest</a></nav>
      </div>
    </header>
    <main class="container">
      <h1>Results ({{ count }})</h1>
      {% if stats %}
      <section class="metrics">
        <div class="metric"><div class="k">Trades</div><div class="v">{{ '%.0f'|format(stats['trades']) }}</div></div>
        <div class="metric"><div class="k">Win rate</div><div class="v">{{ '%.2f'|format(stats['win_rate_pct']) }}%</div></div>
        <div class="metric"><div class="k">Total return</div><div class="v">{{ '%.2f'|format(stats['total_return_pct']) }}%</div></div>
        <div class="metric"><div class="k">Max DD</div><div class="v">{{ '%.2f'|format(stats['max_drawdown_pct']) }}%</div></div>
        <div class="metric"><div class="k">Avg win</div><div class="v">{{ '%.2f'|format(stats['avg_win_pct']) }}%</div></div>
        <div class="metric"><div class="k">Avg loss</div><div class="v">{{ '%.2f'|format(stats['avg_loss_pct']) }}%</div></div>
        <div class="metric"><div class="k">R:R</div><div class="v">{{ '%.2f'|format(stats['risk_reward']) }}</div></div>
      </section>
      {% endif %}
      {% if insights and insights.top_entry_times %}
      <form action="/ui/backtest" method="post" enctype="multipart/form-data" class="card raise">
        <h2>Best entry times (TP hit rate)</h2>
        <p class="sub" style="margin-bottom:8px">Pick up to 3 entry times and re-run backtest on them (upload CSV again).</p>
        <div class="grid" style="grid-template-columns:repeat(6,1fr)">
          <label>Entry time 1
            <select name="entry_time">
              <option value="">--</option>
              {% for t in insights.top_entry_times %}
              <option value="{{ t.time }}">{{ t.time }}</option>
              {% endfor %}
            </select>
          </label>
          <label>Entry time 2
            <select name="entry_time2">
              <option value="">--</option>
              {% for t in insights.top_entry_times %}
              <option value="{{ t.time }}">{{ t.time }}</option>
              {% endfor %}
            </select>
          </label>
          <label>Entry time 3
            <select name="entry_time3">
              <option value="">--</option>
              {% for t in insights.top_entry_times %}
              <option value="{{ t.time }}">{{ t.time }}</option>
              {% endfor %}
            </select>
          </label>
          <label>CSV file
            <input type="file" name="file" accept=".csv" required />
          </label>
          <label>Days (N)
            <input type="number" name="days" value="{{ default_days or 5 }}" min="1" required />
          </label>
          <label>Timezone
            <input type="text" name="tz" value="{{ default_tz or 'Asia/Kolkata' }}" />
          </label>
        </div>
        <div class="grid" style="grid-template-columns:repeat(3,1fr)">
          <label><input type="checkbox" name="cap_small" value="1" checked /> Include Small cap</label>
          <label><input type="checkbox" name="cap_mid" value="1" checked /> Include Mid cap</label>
          <label><input type="checkbox" name="cap_large" value="1" checked /> Include Large cap</label>
        </div>
        <input type="hidden" name="exchange" value="{{ default_exchange or 'NSE' }}" />
        <div class="grid" style="grid-template-columns:repeat(3,1fr)">
          <label>SL % (optional)
            <input type="number" name="sl_pct" step="0.01" placeholder="e.g. 2.0" />
          </label>
          <label>TP % (optional)
            <input type="number" name="tp_pct" step="0.01" placeholder="e.g. 4.0" />
          </label>
          <div style="align-self:end"><button class="btn primary" type="submit">Re-run with selected times</button></div>
        </div>
        <div class="table-wrap"><table>
          <thead><tr><th>Entry Time</th><th>Trades</th><th>TP hits</th><th>TP hit %</th><th>Avg Return %</th></tr></thead>
          <tbody>
            {% for t in insights.top_entry_times %}
            <tr>
              <td>{{ t.time }}</td><td>{{ t.trades }}</td><td>{{ t.tp_hits }}</td><td>{{ '%.2f'|format(t.tp_hit_rate) }}</td><td>{{ '%.2f'|format(t.avg_return) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table></div>
      </form>
      {% endif %}
      {% if insights and insights.cap_performance %}
      <div class="card raise">
        <h2>Performance by cap bucket</h2>
        <div class="table-wrap"><table>
          <thead><tr><th>Cap</th><th>Trades</th><th>Win rate %</th><th>Avg Return %</th></tr></thead>
          <tbody>
            {% for c in insights.cap_performance %}
            <tr>
              <td>{{ c.cap }}</td><td>{{ c.trades }}</td><td>{{ '%.2f'|format(c.win_rate) }}</td><td>{{ '%.2f'|format(c.avg_return) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table></div>
      </div>
      {% endif %}
      {% if error %}
      <div class="banner" style="background:#3a0f0f;border-color:#7f1d1d;color:#fecaca">Error: {{ error }}</div>
      {% endif %}
      <div class="card raise" style="padding:0;margin-top:12px">
        <canvas id="equityChart" height="120"></canvas>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Stock</th>
              <th>Entry Date</th>
              <th>Entry Time</th>
              <th>Entry Price</th>
              <th>Exit Date</th>
              <th>Exit Time</th>
              <th>Exit Price</th>
              <th>Exit Reason</th>
              <th>Return %</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            <tr>
              <td>{{ row["Stock"] }}</td>
              <td>{{ row["Entry Date"] }}</td>
              <td>{{ row["Entry Time"] }}</td>
              <td>{{ row["Entry Price"] }}</td>
              <td>{{ row["Exit Date"] }}</td>
              <td>{{ row.get("Exit Time", "") }}</td>
              <td>{{ row["Exit Price"] }}</td>
              <td>{{ row.get("Exit Reason", "") }}</td>
              <td>{{ row["Return %"] }}</td>
              <td>{{ row.get("Error", "") }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p><a href="/">Back</a></p>
    </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  {% if equity %}
  <script id="equity-data" type="application/json">{{ equity | tojson | safe }}</script>
  {% endif %}
  <script>
    (function(){
      try{
        var el = document.getElementById('equity-data');
        if(!el) return;
        var data = JSON.parse(el.textContent || '[]');
        if(!data.length) return;
        var ctx = document.getElementById('equityChart');
        var labels = data.map(function(_, i){ return i + 1; });
        new Chart(ctx, {
          type: 'line',
          data: { labels: labels, datasets: [{ label: 'Equity (Base=100)', data: data, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.15)', tension: 0.2, fill: true, pointRadius: 0 }]},
          options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.06)' } }, y: { grid: { color: 'rgba(255,255,255,0.06)' } } } }
        });
      } catch(e) {}
    })();
  </script>
  </body>
  </html>


