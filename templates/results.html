<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Backtest results</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <div class="brand"><div class="logo-dot"></div><span>Backtest Results</span></div>
        <nav class="header-actions">
          <a class="btn secondary" href="/">New backtest</a>
        </nav>
      </div>
    </header>
    <main class="container">
      {% if error %}
      <div class="banner" style="background:#3a0f0f;border-color:#7f1d1d;color:#fecaca">Error: {{ error }}</div>
      {% endif %}

      {% if ai_prompt %}
      <div class="banner">AI Strategy prompt used: <em>{{ ai_prompt }}</em></div>
      {% endif %}
      {% if defaults and (defaults.from_date or defaults.to_date) %}
      <div class="banner" style="opacity:0.85">Date filter applied: {{ defaults.from_date or '...' }} → {{ defaults.to_date or '...' }}</div>
      {% endif %}

      <div class="layout-2col">
        <aside class="sidebar">
          <div class="card">
            <h2>Quick Re-run</h2>
            <form id="rerun-form">
              <input type="hidden" name="csv_path" value="{{ csv_path }}" />
              <div class="grid">
                <label>Days
                  <input type="number" name="days" value="{{ (defaults and defaults.days) or 5 }}" min="1" />
                </label>
                <label>SL %
                  <input type="number" name="sl_pct" step="0.01" value="{{ (defaults and defaults.sl_pct) or '' }}" />
                </label>
                <label>TP %
                  <input type="number" name="tp_pct" step="0.01" value="{{ (defaults and defaults.tp_pct) or '' }}" />
                </label>
              </div>
              <div class="grid">
                <label><input type="checkbox" name="cap_small" value="1" checked /> Small</label>
                <label><input type="checkbox" name="cap_mid" value="1" checked /> Mid</label>
                <label><input type="checkbox" name="cap_large" value="1" checked /> Large</label>
              </div>
              <input type="hidden" name="exchange" value="{{ (defaults and defaults.exchange) or 'NSE' }}" />
              <input type="hidden" name="tz" value="{{ (defaults and defaults.tz) or 'Asia/Kolkata' }}" />
              <input type="hidden" name="breakeven_profit_pct" value="{{ (defaults and defaults.breakeven_profit_pct) or '' }}" />
              {% if defaults and defaults.breakeven_at_sl %}
              <input type="hidden" name="breakeven_at_sl" value="1" />
              {% endif %}
              <div style="margin-top:12px">
                <button class="btn primary" type="submit">Re-run</button>
              </div>
            </form>
          </div>

          <div class="card" id="warnings-card" style="display:none">
            <h2>Warnings</h2>
            <ul id="warnings-list"></ul>
          </div>

          <div class="card">
            <h2>Export</h2>
            <div class="grid">
              <button class="btn secondary" id="export-csv">CSV</button>
              <button class="btn secondary" id="export-notes">AI Notes</button>
            </div>
          </div>
        </aside>

        <section class="content">
          <div class="tabs">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="trades">Trades</button>
            <button class="tab-btn" data-tab="entry">Entry Timing</button>
            <button class="tab-btn" data-tab="caps">Cap Buckets</button>
          </div>

          <section class="tab-panel active" id="tab-overview">
      {% if stats %}
      <section class="metrics">
              <div class="metric kpi" data-kpi="trades"><div class="k">Trades</div><div class="v">{{ '%.0f'|format(stats['trades']) }}</div></div>
              <div class="metric kpi" data-kpi="win"><div class="k">Win rate</div><div class="v">{{ '%.2f'|format(stats['win_rate_pct']) }}%</div></div>
              <div class="metric kpi" data-kpi="return"><div class="k">Compounded return</div><div class="v">{{ '%.2f'|format(stats.get('compounded_return_pct', stats['total_return_pct'])) }}%</div></div>
              <div class="metric kpi" data-kpi="drawdown"><div class="k">Max DD</div><div class="v">{{ '%.2f'|format(stats['max_drawdown_pct']) }}%</div></div>
        <div class="metric"><div class="k">R:R</div><div class="v">{{ '%.2f'|format(stats['risk_reward']) }}</div></div>
              <div class="metric"><div class="k">Expectancy</div><div class="v">{{ '%.2f'|format(stats['expectancy_pct']) }}%</div></div>
              <div class="metric"><div class="k">Calmar</div><div class="v">{{ '%.2f'|format(stats['calmar_ratio']) }}</div></div>
      </section>
      {% endif %}

            <div class="card raise" style="padding:0;margin-top:12px">
              <canvas id="equityChart" height="140"></canvas>
            </div>

            <div class="card" id="ai-summary">
              <h2>AI Summary</h2>
              <div id="ai-summary-text" class="sub">Generating summary...</div>
            </div>
          </section>

          <section class="tab-panel" id="tab-trades">
            <div class="card">
              <div class="grid">
                <label>Filter
                  <select id="trade-filter">
                    <option value="all">All trades</option>
                    <option value="winners">Winners</option>
                    <option value="losers">Losers</option>
                    <option value="tp">TP hit</option>
                    <option value="sl">SL hit</option>
            </select>
          </label>
                <label>Sort by
                  <select id="trade-sort">
                    <option value="none">None</option>
                    <option value="ret_desc">Return % (desc)</option>
                    <option value="ret_asc">Return % (asc)</option>
            </select>
          </label>
      </div>
      </div>
      <div class="table-wrap">
              <table id="trades-table">
          <thead>
            <tr>
              <th>Stock</th>
              <th>Entry Date</th>
              <th>Entry Time</th>
              <th>Entry Price</th>
              <th>Exit Date</th>
              <th>Exit Time</th>
              <th>Exit Price</th>
              <th>Exit Reason</th>
              <th>Return %</th>
              <th>Error</th>
            </tr>
          </thead>
                <tbody id="trades-body">
            {% for row in rows %}
            <tr>
              <td>{{ row["Stock"] }}</td>
              <td>{{ row["Entry Date"] }}</td>
              <td>{{ row["Entry Time"] }}</td>
              <td>{{ row["Entry Price"] }}</td>
              <td>{{ row["Exit Date"] }}</td>
              <td>{{ row.get("Exit Time", "") }}</td>
              <td>{{ row["Exit Price"] }}</td>
              <td>{{ row.get("Exit Reason", "") }}</td>
              <td>{{ row["Return %"] }}</td>
              <td>{{ row.get("Error", "") }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
          </section>

          <section class="tab-panel" id="tab-entry">
            {% if insights and insights.top_entry_times %}
            <div class="card">
              <h2>Best entry times</h2>
              <canvas id="entryChart" height="140"></canvas>
              <div class="table-wrap" style="margin-top:12px"><table>
                <thead><tr><th>Entry Time</th><th>Trades</th><th>TP hits</th><th>TP hit %</th><th>Avg Return %</th></tr></thead>
                <tbody>
                  {% for t in insights.top_entry_times %}
                  <tr>
                    <td>{{ t.time }}</td><td>{{ t.trades }}</td><td>{{ t.tp_hits }}</td><td>{{ '%.2f'|format(t.tp_hit_rate) }}</td><td>{{ '%.2f'|format(t.avg_return) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table></div>
            </div>
            {% endif %}
          </section>

          <section class="tab-panel" id="tab-caps">
            {% if insights and insights.cap_performance %}
            <div class="card">
              <h2>Cap bucket performance</h2>
              <canvas id="capChart" height="140"></canvas>
            </div>
            {% endif %}
          </section>
        </section>

        <aside class="assistant-panel" id="assistant">
          <div class="assistant-header">
            <strong>AI Assistant</strong>
            <button id="assistant-toggle">⇔</button>
          </div>
          <div id="assistant-body">
            <div class="assistant-messages" id="assistant-messages"></div>
            <form id="assistant-form">
              <input type="text" id="assistant-input" placeholder="Ask about risks, caps, SL/TP..." />
              <button class="btn primary" type="submit">Ask</button>
            </form>
          </div>
        </aside>
      </div>

    </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  {% if equity %}
  <script id="equity-data" type="application/json">{{ equity | tojson | safe }}</script>
  {% endif %}
    <script id="backtest-json" type="application/json">{ "stats": {{ stats | tojson | safe }}, "insights": {{ insights | tojson | safe }}, "rows": {{ rows | tojson | safe }} }</script>
  <script>
      // Tabs
      document.querySelectorAll('.tab-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          document.querySelectorAll('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
          document.querySelectorAll('.tab-panel').forEach(function(p){ p.classList.remove('active'); });
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });

      // KPI coloring
      (function(){
        try{
          var stats = JSON.parse(document.getElementById('backtest-json').textContent).stats || {};
          function badge(el, good, warn){
            var v = parseFloat(el.querySelector('.v').textContent);
            el.classList.remove('kpi-good','kpi-warn','kpi-bad');
            if (isNaN(v)) return;
            if (good(v)) el.classList.add('kpi-good'); else if (warn(v)) el.classList.add('kpi-warn'); else el.classList.add('kpi-bad');
          }
          document.querySelectorAll('.metric.kpi').forEach(function(el){
            var type = el.dataset.kpi;
            if (type === 'win') badge(el, function(v){return v>=50}, function(v){return v>=40});
            if (type === 'return') badge(el, function(v){return v>=20}, function(v){return v>=10});
            if (type === 'drawdown') badge(el, function(v){return v<=8}, function(v){return v<=15});
          });
        }catch(e){}
      })();

      // Equity chart
    (function(){
      try{
        var el = document.getElementById('equity-data');
        if(!el) return;
        var data = JSON.parse(el.textContent || '[]');
        if(!data.length) return;
        var ctx = document.getElementById('equityChart');
        var labels = data.map(function(_, i){ return i + 1; });
        new Chart(ctx, {
          type: 'line',
          data: { labels: labels, datasets: [{ label: 'Equity (Base=100)', data: data, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.15)', tension: 0.2, fill: true, pointRadius: 0 }]},
          options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.06)' } }, y: { grid: { color: 'rgba(255,255,255,0.06)' } } } }
        });
      } catch(e) {}
    })();

      // Entry timing chart
      (function(){
        try{
          var data = (JSON.parse(document.getElementById('backtest-json').textContent).insights || {}).top_entry_times || [];
          if(!data.length) return;
          var ctx = document.getElementById('entryChart');
          new Chart(ctx, {
            type: 'bar',
            data: { labels: data.map(function(d){return d.time;}), datasets: [
              { label: 'TP hit %', data: data.map(function(d){return d.tp_hit_rate;}), backgroundColor: 'rgba(34,197,94,0.6)' },
              { label: 'Avg Return %', data: data.map(function(d){return d.avg_return;}), backgroundColor: 'rgba(59,130,246,0.6)' }
            ]},
            options: { responsive: true, scales: { x: { stacked: true }, y: { beginAtZero: true } } }
          });
        }catch(e){}
      })();

      // Cap bucket chart
      (function(){
        try{
          var caps = (JSON.parse(document.getElementById('backtest-json').textContent).insights || {}).cap_performance || [];
          if(!caps.length) return;
          var ctx = document.getElementById('capChart');
          new Chart(ctx, {
            type: 'bar',
            data: { labels: caps.map(function(c){return c.cap;}), datasets: [
              { label: 'Win %', data: caps.map(function(c){return c.win_rate;}), backgroundColor: 'rgba(34,197,94,0.6)' },
              { label: 'Avg Return %', data: caps.map(function(c){return c.avg_return;}), backgroundColor: 'rgba(59,130,246,0.6)' }
            ] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
          });
        }catch(e){}
      })();

      // Trades filters and warnings
      (function(){
        try{
          var rows = JSON.parse(document.getElementById('backtest-json').textContent).rows || [];
          var tbody = document.getElementById('trades-body');
          var filterEl = document.getElementById('trade-filter');
          var sortEl = document.getElementById('trade-sort');

          function render(){
            var data = rows.slice();
            var f = filterEl.value;
            if (f !== 'all'){
              data = data.filter(function(r){
                var ret = parseFloat(r['Return %'] || 0);
                var reason = (r['Exit Reason'] || '').toLowerCase();
                if (f==='winners') return ret>0;
                if (f==='losers') return ret<0;
                if (f==='tp') return reason.indexOf('tp')>=0 || reason.indexOf('take')>=0;
                if (f==='sl') return reason.indexOf('sl')>=0 || reason.indexOf('stop')>=0;
                return true;
              });
            }
            var s = sortEl.value;
            if (s==='ret_desc') data.sort(function(a,b){ return (parseFloat(b['Return %']||0) - parseFloat(a['Return %']||0)); });
            if (s==='ret_asc') data.sort(function(a,b){ return (parseFloat(a['Return %']||0) - parseFloat(b['Return %']||0)); });

            tbody.innerHTML = data.map(function(r){
              return '<tr>'+
                '<td>'+ (r['Stock']||'') +'</td>'+
                '<td>'+ (r['Entry Date']||'') +'</td>'+
                '<td>'+ (r['Entry Time']||'') +'</td>'+
                '<td>'+ (r['Entry Price']||'') +'</td>'+
                '<td>'+ (r['Exit Date']||'') +'</td>'+
                '<td>'+ (r['Exit Time']||'') +'</td>'+
                '<td>'+ (r['Exit Price']||'') +'</td>'+
                '<td>'+ (r['Exit Reason']||'') +'</td>'+
                '<td>'+ (r['Return %']||'') +'</td>'+
                '<td>'+ (r['Error']||'') +'</td>'+
              '</tr>';
            }).join('');
          }

          render();
          filterEl.addEventListener('change', render);
          sortEl.addEventListener('change', render);

          // Warnings
          var warnings = Array.from(new Set(rows.map(function(r){ return (r['Error']||'').trim(); }).filter(Boolean)));
          if (warnings.length){
            document.getElementById('warnings-card').style.display = '';
            var ul = document.getElementById('warnings-list');
            warnings.forEach(function(w){
              var li = document.createElement('li'); li.textContent = w; ul.appendChild(li);
            });
          }
        }catch(e){}
      })();

      // Quick rerun
      (function(){
        var form = document.getElementById('rerun-form');
        if(!form) return;
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          var fd = new FormData(form);
          var resp = await fetch('/ui/rerun', { method: 'POST', body: fd });
          var html = await resp.text(); document.open(); document.write(html); document.close();
        });
      })();

      // Assistant
      (function(){
        var toggle = document.getElementById('assistant-toggle');
        var panel = document.getElementById('assistant');
        toggle.addEventListener('click', function(){ panel.classList.toggle('collapsed'); });

        var btJson = document.getElementById('backtest-json').textContent;
        async function aiSummary(){
          try{
            var fd = new FormData(); fd.append('bt_json', btJson);
            var r = await fetch('/ui/ai_summary', { method: 'POST', body: fd });
            var t = await r.text();
            document.getElementById('ai-summary-text').textContent = t;
          }catch(e){ document.getElementById('ai-summary-text').textContent = 'AI summary unavailable'; }
        }
        aiSummary();

        var form = document.getElementById('assistant-form');
        var input = document.getElementById('assistant-input');
        var msgs = document.getElementById('assistant-messages');
        function addMsg(text, who){
          var div = document.createElement('div');
          div.className = 'msg msg-'+who; div.textContent = text; msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
        }
        form.addEventListener('submit', async function(e){
          e.preventDefault(); var q = input.value.trim(); if(!q) return; addMsg(q,'user'); input.value='';
          try{ var fd = new FormData(); fd.append('question', q); fd.append('bt_json', btJson); var r = await fetch('/ui/ai_chat', { method:'POST', body: fd }); var t = await r.text(); addMsg(t,'ai'); }catch(e){ addMsg('AI unavailable','ai'); }
        });
      })();

      // Export actions
      (function(){
        var btnCsv = document.getElementById('export-csv');
        var btnNotes = document.getElementById('export-notes');
        if(btnCsv){ btnCsv.addEventListener('click', function(){
          var f = new FormData(document.getElementById('rerun-form'));
          fetch('/ui/export_csv', { method:'POST', body: f }).then(function(r){ return r.blob(); }).then(function(b){ var a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backtest.csv'; a.click(); });
        }); }
        if(btnNotes){ btnNotes.addEventListener('click', function(){ var f = new FormData(); f.append('bt_json', document.getElementById('backtest-json').textContent); fetch('/ui/export_notes', { method:'POST', body: f }).then(function(r){ return r.blob(); }).then(function(b){ var a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'ai_notes.txt'; a.click(); }); }); }
      })();
  </script>
  </body>
  </html>


